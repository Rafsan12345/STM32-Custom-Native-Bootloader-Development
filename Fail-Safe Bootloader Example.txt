/* main.c - Fail-Safe Bootloader */
#include "main.h"
#include "stm32f1xx_hal.h"

uint32_t CalculateCRC(uint32_t start, uint32_t length); // Assume implemented
void JumpToApplication(uint32_t appAddress) { /* same as above */ }

int main(void) {
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_USART1_UART_Init();

    uint32_t appCRC = *(__IO uint32_t*)(0x08004000 + length - 4);
    if(CalculateCRC(0x08004000, length-4) == appCRC) JumpToApplication(0x08004000); // Valid firmware
    else HAL_GPIO_WritePin(GPIOC, GPIO_PIN_13, GPIO_PIN_SET); // LED on: invalid firmware / update needed

    while(1) {}
}
